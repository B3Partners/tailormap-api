<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GeoService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Aggregate Test Coverage</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.tailormap.api.persistence</a> &gt; <span class="el_source">GeoService.java</span></div><h1>GeoService.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2023 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */
package nl.b3p.tailormap.api.persistence;

import com.fasterxml.jackson.annotation.JsonIgnore;
import io.hypersistence.tsid.TSID;
import jakarta.persistence.Basic;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EntityListeners;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.FetchType;
import jakarta.persistence.Id;
import jakarta.persistence.PrePersist;
import jakarta.persistence.Transient;
import jakarta.persistence.Version;
import jakarta.validation.constraints.NotNull;
import java.lang.invoke.MethodHandles;
import java.nio.charset.StandardCharsets;
import java.time.Instant;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Optional;
import nl.b3p.tailormap.api.persistence.helper.GeoServiceHelper;
import nl.b3p.tailormap.api.persistence.json.AuthorizationRule;
import nl.b3p.tailormap.api.persistence.json.GeoServiceDefaultLayerSettings;
import nl.b3p.tailormap.api.persistence.json.GeoServiceLayer;
import nl.b3p.tailormap.api.persistence.json.GeoServiceLayerSettings;
import nl.b3p.tailormap.api.persistence.json.GeoServiceProtocol;
import nl.b3p.tailormap.api.persistence.json.GeoServiceSettings;
import nl.b3p.tailormap.api.persistence.json.ServiceAuthentication;
import nl.b3p.tailormap.api.persistence.json.TMServiceCaps;
import nl.b3p.tailormap.api.persistence.listener.EntityEventPublisher;
import nl.b3p.tailormap.api.repository.FeatureSourceRepository;
import nl.b3p.tailormap.api.repository.SearchIndexRepository;
import nl.b3p.tailormap.api.util.TMStringUtils;
import nl.b3p.tailormap.api.viewer.model.Service;
import org.apache.commons.lang3.StringUtils;
import org.hibernate.annotations.Type;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.lang.NonNull;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.util.UriComponentsBuilder;

@Entity
@EntityListeners(EntityEventPublisher.class)
<span class="fc" id="L55">public class GeoService {</span>
  private static final Logger logger =
<span class="fc" id="L57">      LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

<span class="fc" id="L59">  private static final List&lt;String&gt; REMOVE_PARAMS = List.of(&quot;REQUEST&quot;);</span>

  @Id private String id;

  @Version private Long version;

  @Column(columnDefinition = &quot;text&quot;)
  private String notes;

  @NotNull
  @Enumerated(EnumType.STRING)
  private GeoServiceProtocol protocol;

  /**
   * The URL from which the capabilities of this service can be loaded and the URL to use for the
   * service, except when the advertisedUrl should be used by explicit user request. TODO: never use
   * URL in capabilities? TODO: explicitly specify relative URLs can be used? Or even if it should
   * be automatically converted to a relative URL if the hostname/port matches our URL? TODO: what
   * to do with parameters such as VERSION in the URL?
   */
  @NotNull
  @Column(length = 2048)
  private String url;

  @Transient private boolean refreshCapabilities;

  /**
   * Non-null when authentication is required for this service. Currently, the only authentication
   * method is password (HTTP Basic).
   */
  @Type(value = io.hypersistence.utils.hibernate.type.json.JsonBinaryType.class)
  @Column(columnDefinition = &quot;jsonb&quot;)
  private ServiceAuthentication authentication;

  /**
   * Original capabilities as received from the service. This can be used for capability information
   * not already parsed in this entity, such as tiling information.
   */
  @Basic(fetch = FetchType.LAZY)
  @JsonIgnore
  private byte[] capabilities;

  /**
   * Content type of capabilities. &quot;application/xml&quot; for WMS/WMTS and &quot;application/json&quot; for REST
   * services.
   */
  private String capabilitiesContentType;

  /** The instant the capabilities where last successfully fetched and parsed. */
  private Instant capabilitiesFetched;

  /** Title loaded from capabilities or as modified by user for display. */
  @NotNull
  @Column(length = 2048)
  private String title;

  /**
   * A service may advertise a URL in its capabilities which does not actually work, for example if
   * the service is behind a proxy. Usually this shouldn't be used.
   */
  @Column(length = 2048)
  private String advertisedUrl;

  @Type(value = io.hypersistence.utils.hibernate.type.json.JsonBinaryType.class)
  @Column(columnDefinition = &quot;jsonb&quot;)
  private TMServiceCaps serviceCapabilities;

<span class="fc" id="L126">  @Type(value = io.hypersistence.utils.hibernate.type.json.JsonBinaryType.class)</span>
  @Column(columnDefinition = &quot;jsonb&quot;)
  @NotNull
  private List&lt;AuthorizationRule&gt; authorizationRules = new ArrayList&lt;&gt;();

<span class="fc" id="L131">  @Type(value = io.hypersistence.utils.hibernate.type.json.JsonBinaryType.class)</span>
  @Column(columnDefinition = &quot;jsonb&quot;)
  @NotNull
  private List&lt;GeoServiceLayer&gt; layers = new ArrayList&lt;&gt;();

  private boolean published;

  /**
   * Settings relevant for Tailormap use cases, such as configuring the specific server type for
   * vendor-specific capabilities etc.
   */
<span class="fc" id="L142">  @Type(value = io.hypersistence.utils.hibernate.type.json.JsonBinaryType.class)</span>
  @Column(columnDefinition = &quot;jsonb&quot;)
  @NotNull
  private GeoServiceSettings settings = new GeoServiceSettings();

  // &lt;editor-fold desc=&quot;getters and setters&quot;&gt;
  public String getId() {
<span class="nc" id="L149">    return id;</span>
  }

  public GeoService setId(String id) {
<span class="nc" id="L153">    this.id = id;</span>
<span class="nc" id="L154">    return this;</span>
  }

  public Long getVersion() {
<span class="nc" id="L158">    return version;</span>
  }

  public GeoService setVersion(Long version) {
<span class="nc" id="L162">    this.version = version;</span>
<span class="nc" id="L163">    return this;</span>
  }

  public String getNotes() {
<span class="nc" id="L167">    return notes;</span>
  }

  public GeoService setNotes(String adminComments) {
<span class="nc" id="L171">    this.notes = adminComments;</span>
<span class="nc" id="L172">    return this;</span>
  }

  public GeoServiceProtocol getProtocol() {
<span class="nc" id="L176">    return protocol;</span>
  }

  public GeoService setProtocol(GeoServiceProtocol protocol) {
<span class="nc" id="L180">    this.protocol = protocol;</span>
<span class="nc" id="L181">    return this;</span>
  }

  public String getUrl() {
<span class="fc" id="L185">    return url;</span>
  }

  /** Sets the url after sanitising (removing unwanted parameters). */
  public GeoService setUrl(String url) {
<span class="fc" id="L190">    this.url = sanitiseUrl(url);</span>
<span class="fc" id="L191">    return this;</span>
  }

  public boolean isRefreshCapabilities() {
<span class="nc" id="L195">    return refreshCapabilities;</span>
  }

  public void setRefreshCapabilities(boolean refreshCapabilities) {
<span class="nc" id="L199">    this.refreshCapabilities = refreshCapabilities;</span>
<span class="nc" id="L200">  }</span>

  public ServiceAuthentication getAuthentication() {
<span class="nc" id="L203">    return authentication;</span>
  }

  public GeoService setAuthentication(ServiceAuthentication authentication) {
<span class="nc" id="L207">    this.authentication = authentication;</span>
<span class="nc" id="L208">    return this;</span>
  }

  public byte[] getCapabilities() {
<span class="nc" id="L212">    return capabilities;</span>
  }

  public GeoService setCapabilities(byte[] capabilities) {
<span class="nc" id="L216">    this.capabilities = capabilities;</span>
<span class="nc" id="L217">    return this;</span>
  }

  public String getCapabilitiesContentType() {
<span class="nc" id="L221">    return capabilitiesContentType;</span>
  }

  public GeoService setCapabilitiesContentType(String capabilitiesContentType) {
<span class="nc" id="L225">    this.capabilitiesContentType = capabilitiesContentType;</span>
<span class="nc" id="L226">    return this;</span>
  }

  public Instant getCapabilitiesFetched() {
<span class="nc" id="L230">    return capabilitiesFetched;</span>
  }

  public GeoService setCapabilitiesFetched(Instant capabilitiesFetched) {
<span class="nc" id="L234">    this.capabilitiesFetched = capabilitiesFetched;</span>
<span class="nc" id="L235">    return this;</span>
  }

  public String getTitle() {
<span class="nc" id="L239">    return title;</span>
  }

  public GeoService setTitle(String title) {
<span class="nc" id="L243">    this.title = title;</span>
<span class="nc" id="L244">    return this;</span>
  }

  public String getAdvertisedUrl() {
<span class="nc" id="L248">    return advertisedUrl;</span>
  }

  public GeoService setAdvertisedUrl(String advertisedUrl) {
<span class="nc" id="L252">    this.advertisedUrl = advertisedUrl;</span>
<span class="nc" id="L253">    return this;</span>
  }

  public TMServiceCaps getServiceCapabilities() {
<span class="nc" id="L257">    return serviceCapabilities;</span>
  }

  public GeoService setServiceCapabilities(TMServiceCaps serviceCapabilities) {
<span class="nc" id="L261">    this.serviceCapabilities = serviceCapabilities;</span>
<span class="nc" id="L262">    return this;</span>
  }

  public List&lt;AuthorizationRule&gt; getAuthorizationRules() {
<span class="nc" id="L266">    return authorizationRules;</span>
  }

  public GeoService setAuthorizationRules(List&lt;AuthorizationRule&gt; authorizationRules) {
<span class="nc" id="L270">    this.authorizationRules = authorizationRules;</span>
<span class="nc" id="L271">    return this;</span>
  }

  public List&lt;GeoServiceLayer&gt; getLayers() {
<span class="nc" id="L275">    return layers;</span>
  }

  public GeoService setLayers(List&lt;GeoServiceLayer&gt; layers) {
<span class="nc" id="L279">    this.layers = layers;</span>
<span class="nc" id="L280">    return this;</span>
  }

  public boolean isPublished() {
<span class="nc" id="L284">    return published;</span>
  }

  public GeoService setPublished(boolean published) {
<span class="nc" id="L288">    this.published = published;</span>
<span class="nc" id="L289">    return this;</span>
  }

  public GeoServiceSettings getSettings() {
<span class="nc" id="L293">    return settings;</span>
  }

  public GeoService setSettings(GeoServiceSettings settings) {
<span class="nc" id="L297">    this.settings = settings;</span>
<span class="nc" id="L298">    return this;</span>
  }

  // &lt;/editor-fold&gt;

  @PrePersist
  public void assignId() {
<span class="nc bnc" id="L305" title="All 2 branches missed.">    if (StringUtils.isBlank(getId())) {</span>
      // We kind of misuse TSIDs here, because we store it as a string. This is because the id
      // string can also be manually assigned. There won't be huge numbers of GeoServices, so it's
      // more of a convenient way to generate an ID that isn't a huge UUID string.
<span class="nc" id="L309">      setId(TSID.fast().toString());</span>
    }
<span class="nc" id="L311">  }</span>

  public Service toJsonPojo(GeoServiceHelper geoServiceHelper) {
    Service.ServerTypeEnum serverTypeEnum;
<span class="nc bnc" id="L315" title="All 2 branches missed.">    if (settings.getServerType() == GeoServiceSettings.ServerTypeEnum.AUTO) {</span>
<span class="nc" id="L316">      serverTypeEnum = geoServiceHelper.guessServerTypeFromUrl(getUrl());</span>
    } else {
<span class="nc" id="L318">      serverTypeEnum = Service.ServerTypeEnum.fromValue(settings.getServerType().getValue());</span>
    }

<span class="nc" id="L321">    Service s =</span>
        new Service()
<span class="nc" id="L323">            .id(this.id)</span>
<span class="nc" id="L324">            .title(this.title)</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">            .url(Boolean.TRUE.equals(this.getSettings().getUseProxy()) ? null : this.url)</span>
<span class="nc" id="L326">            .protocol(this.protocol)</span>
<span class="nc" id="L327">            .serverType(serverTypeEnum);</span>

<span class="nc bnc" id="L329" title="All 2 branches missed.">    if (this.protocol == GeoServiceProtocol.WMTS) {</span>
      // Frontend requires WMTS capabilities to parse TilingMatrix, but WMS capabilities aren't used
      // XXX UTF-8 only, maybe use base64
<span class="nc" id="L332">      s.capabilities(new String(getCapabilities(), StandardCharsets.UTF_8));</span>
    }

<span class="nc" id="L335">    return s;</span>
  }

  public GeoServiceLayer findLayer(String name) {
<span class="nc" id="L339">    return getLayers().stream().filter(sl -&gt; name.equals(sl.getName())).findFirst().orElse(null);</span>
  }

  public GeoServiceLayerSettings getLayerSettings(String layerName) {
<span class="nc" id="L343">    return getSettings().getLayerSettings().get(layerName);</span>
  }

  @NonNull
  public String getTitleWithSettingsOverrides(String layerName) {
    // First use title in layer settings
<span class="nc" id="L349">    String title =</span>
<span class="nc" id="L350">        Optional.ofNullable(getLayerSettings(layerName))</span>
<span class="nc" id="L351">            .map(GeoServiceLayerSettings::getTitle)</span>
<span class="nc" id="L352">            .map(TMStringUtils::nullIfEmpty)</span>
<span class="nc" id="L353">            .orElse(null);</span>

    // If not set, title from capabilities
<span class="nc bnc" id="L356" title="All 2 branches missed.">    if (title == null) {</span>
<span class="nc" id="L357">      title =</span>
<span class="nc" id="L358">          Optional.ofNullable(findLayer(layerName))</span>
<span class="nc" id="L359">              .map(GeoServiceLayer::getTitle)</span>
<span class="nc" id="L360">              .map(TMStringUtils::nullIfEmpty)</span>
<span class="nc" id="L361">              .orElse(null);</span>
    }

    // Do not get title from default layer settings (a default title wouldn't make sense)

    // If still not set, use layer name as title
<span class="nc bnc" id="L367" title="All 2 branches missed.">    if (title == null) {</span>
<span class="nc" id="L368">      title = layerName;</span>
    }

<span class="nc" id="L371">    return title;</span>
  }

  public TMFeatureType findFeatureTypeForLayer(
      GeoServiceLayer layer, FeatureSourceRepository featureSourceRepository) {

<span class="nc" id="L377">    GeoServiceDefaultLayerSettings defaultLayerSettings = getSettings().getDefaultLayerSettings();</span>
<span class="nc" id="L378">    GeoServiceLayerSettings layerSettings = getLayerSettings(layer.getName());</span>

<span class="nc" id="L380">    Long featureSourceId = null;</span>
    String featureTypeName;

<span class="nc bnc" id="L383" title="All 4 branches missed.">    if (layerSettings != null &amp;&amp; layerSettings.getFeatureType() != null) {</span>
<span class="nc" id="L384">      featureTypeName =</span>
<span class="nc" id="L385">          Optional.ofNullable(layerSettings.getFeatureType().getFeatureTypeName())</span>
<span class="nc" id="L386">              .orElse(layer.getName());</span>
<span class="nc" id="L387">      featureSourceId = layerSettings.getFeatureType().getFeatureSourceId();</span>
    } else {
<span class="nc" id="L389">      featureTypeName = layer.getName();</span>
    }

<span class="nc bnc" id="L392" title="All 4 branches missed.">    if (featureSourceId == null</span>
        &amp;&amp; defaultLayerSettings != null
<span class="nc bnc" id="L394" title="All 2 branches missed.">        &amp;&amp; defaultLayerSettings.getFeatureType() != null) {</span>
<span class="nc" id="L395">      featureSourceId = defaultLayerSettings.getFeatureType().getFeatureSourceId();</span>
    }

<span class="nc bnc" id="L398" title="All 2 branches missed.">    if (featureTypeName == null) {</span>
<span class="nc" id="L399">      return null;</span>
    }

<span class="nc" id="L402">    TMFeatureSource tmfs = null;</span>
<span class="nc" id="L403">    TMFeatureType tmft = null;</span>

<span class="nc bnc" id="L405" title="All 2 branches missed.">    if (featureSourceId == null) {</span>
<span class="nc" id="L406">      List&lt;TMFeatureSource&gt; linkedSources = featureSourceRepository.findByLinkedServiceId(getId());</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">      for (TMFeatureSource linkedFs : linkedSources) {</span>
<span class="nc" id="L408">        tmft = linkedFs.findFeatureTypeByName(featureTypeName);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">        if (tmft != null) {</span>
<span class="nc" id="L410">          tmfs = linkedFs;</span>
<span class="nc" id="L411">          break;</span>
        }
<span class="nc" id="L413">      }</span>
<span class="nc" id="L414">    } else {</span>
<span class="nc" id="L415">      tmfs = featureSourceRepository.findById(featureSourceId).orElse(null);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">      if (tmfs != null) {</span>
<span class="nc" id="L417">        tmft = tmfs.findFeatureTypeByName(featureTypeName);</span>
      }
    }

<span class="nc bnc" id="L421" title="All 2 branches missed.">    if (tmfs == null) {</span>
<span class="nc" id="L422">      return null;</span>
    }

<span class="nc bnc" id="L425" title="All 2 branches missed.">    if (tmft == null) {</span>
<span class="nc" id="L426">      String[] split = featureTypeName.split(&quot;:&quot;, 2);</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">      if (split.length == 2) {</span>
<span class="nc" id="L428">        String shortFeatureTypeName = split[1];</span>
<span class="nc" id="L429">        tmft = tmfs.findFeatureTypeByName(shortFeatureTypeName);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">        if (tmft != null) {</span>
<span class="nc" id="L431">          logger.debug(</span>
              &quot;Did not find feature type with full name \&quot;{}\&quot;, using \&quot;{}\&quot; of feature source {}&quot;,
              featureTypeName,
              shortFeatureTypeName,
              tmfs);
        }
      }
    }
<span class="nc" id="L439">    return tmft;</span>
  }

  /**
   * Find the search index for the given layer. If the layer has a specific search index, that one
   * is returned. If not, {@code null} is returned.
   *
   * @param layer the layer to find the search index for
   * @param searchIndexRepository repository to find the search index
   * @return the search index for the layer, or {@code null} if no search index is found
   */
  public Optional&lt;SearchIndex&gt; findSearchIndexForLayer(
      GeoServiceLayer layer, SearchIndexRepository searchIndexRepository) {

<span class="nc" id="L453">    GeoServiceDefaultLayerSettings defaultLayerSettings = getSettings().getDefaultLayerSettings();</span>
<span class="nc" id="L454">    GeoServiceLayerSettings layerSettings = getLayerSettings(layer.getName());</span>

<span class="nc" id="L456">    Long searchIndexId = null;</span>
<span class="nc bnc" id="L457" title="All 4 branches missed.">    if (layerSettings != null &amp;&amp; layerSettings.getSearchIndex() != null) {</span>
<span class="nc" id="L458">      searchIndexId = layerSettings.getSearchIndex().getSearchIndexId();</span>
    }
<span class="nc bnc" id="L460" title="All 4 branches missed.">    if (searchIndexId == null</span>
        &amp;&amp; defaultLayerSettings != null
<span class="nc bnc" id="L462" title="All 2 branches missed.">        &amp;&amp; defaultLayerSettings.getSearchIndex() != null) {</span>
<span class="nc" id="L463">      searchIndexId = defaultLayerSettings.getSearchIndex().getSearchIndexId();</span>
    }
<span class="nc bnc" id="L465" title="All 2 branches missed.">    return (null == searchIndexId)</span>
<span class="nc" id="L466">        ? Optional.empty()</span>
<span class="nc" id="L467">        : searchIndexRepository.findById(searchIndexId);</span>
  }

  /**
   * Remove all parameters from the URL that are listed in {@link #REMOVE_PARAMS}.
   *
   * @param url URL to sanitise
   * @return sanitised URL
   */
  private String sanitiseUrl(String url) {
<span class="pc bpc" id="L477" title="1 of 4 branches missed.">    if (url != null &amp;&amp; url.contains(&quot;?&quot;)) {</span>
<span class="fc" id="L478">      MultiValueMap&lt;String, String&gt; sanitisedParams = new LinkedMultiValueMap&lt;&gt;();</span>
<span class="fc" id="L479">      UriComponentsBuilder uri = UriComponentsBuilder.fromUriString(url);</span>
<span class="fc" id="L480">      MultiValueMap&lt;String, String&gt; /* unmodifiable */ requestParams = uri.build().getQueryParams();</span>
<span class="fc bfc" id="L481" title="All 2 branches covered.">      for (Map.Entry&lt;String, List&lt;String&gt;&gt; param : requestParams.entrySet()) {</span>
<span class="fc bfc" id="L482" title="All 2 branches covered.">        if (!REMOVE_PARAMS.contains(param.getKey().toUpperCase(Locale.ROOT))) {</span>
<span class="fc" id="L483">          sanitisedParams.put(param.getKey(), param.getValue());</span>
        }
<span class="fc" id="L485">      }</span>

<span class="fc" id="L487">      url = uri.replaceQueryParams(sanitisedParams).build().toUriString();</span>
<span class="pc bpc" id="L488" title="1 of 2 branches missed.">      if (url.endsWith(&quot;?&quot;)) {</span>
<span class="nc" id="L489">        url = url.substring(0, url.length() - 1);</span>
      }
    }
<span class="fc" id="L492">    return url;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>